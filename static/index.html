<!DOCTYPE html>
<meta charset="utf-8">
<base target="_blank">
<link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet/less" href="/styles.less">
<script>
var COLUMN_WIDTH = 210;
var GUTTER_WIDTH = 20;

var less = {
  globalVars: {
    columnWidth: COLUMN_WIDTH + 'px',
    gutterWidth: GUTTER_WIDTH + 'px'
  }
};
</script>
<script src="/vendor/less.js"></script>
<title>Life of The Law Masonry Prototype</title>
<div class="nav">
  <div class="container">
    <h1>LOGO</h1>
    <ul>
      <li><a href="#">Topics</a></li>
      <li><a href="http://www.lifeofthelaw.org/livelaw/">Live Law</a></li>
      <li><a href="http://www.lifeofthelaw.org/about/">About</a></li>
      <li><a href="https://donatenow.networkforgood.org/Lifeofthelaw">Donate</a></li>
    </ul>
    <div class="search"><input id="search" type="text" placeholder="Search" autocomplete="off"></div>
  </div>
</div>
<div class="container">
  <div class="player">
    <div class="episode" role="show-playlist">
      <span class="title"></span>
      <span class="subtitle">Latest Episode</span>
      <i class="fa fa-caret-down"></i>
    </div>
    <audio id="mp3player" preload="auto"></audio>
  </div>
</div>
<div class="container" id="results-holder">
  <div id="results" class="masonry-container"></div>
  <div id="more" style="display: none"><i class="fa fa-chevron-circle-down"></i></div>
  <div id="spinner"><i class="fa fa-circle-o-notch fa-spin"></i></div>
</div>
<footer>
  <div class="container">
    <p>Life of The Law is a super awesome 360 degree view of our legal system.</p>
    <p><small>There should really be more content here.</small></p>
  </div>
</footer>
<script type="text/html" id="playlist-template">
  <ul class="playlist">
    {% for podcast in podcasts %}
      {% if podcast.id != currentID %}
      <li role="play-podcast"
          data-podcast-info="{{ podcast.enclosurePodcastInfo }}">{{ podcast.title|safe }}</li>
      {% endif %}
    {% endfor %}
    <li role="show-all-episodes"><em>Show all episodes&hellip;</em></li>
  </ul>
</script>
<script type="text/html" id="post-template">
  <div class="post{% if isWide %} wide{% endif %}">
    {% if isWide %}
    <div class="post-thumbnail"{% if thumbnail %} style="background-image: url({{ thumbnail.url }})"{% endif %}></div>
    {% endif %}
    {% if not isWide and thumbnail %}
    <img src="{{ thumbnail.url }}" width="{{ thumbnail.width }}" height="{{ thumbnail.height }}">
    {% endif %}
    <div class="post-details">
      <h3><a href="{{ link }}">{{ title|safe }}</a></h3>
      <p class="post-pubdate">Posted {{ pubdate.toDateString() }}</p>
      {% if excerpt %}
      <p>{{ excerpt|safe }}</p>
      {% endif %}
      <ul class="post-actions">
        {% if enclosure %}
        <li><a 
          role="play-podcast"
          data-podcast-info="{{ enclosurePodcastInfo }}"
          href="{{ enclosure }}"><i class="fa fa-play-circle"></i> Listen</a></li>
        {% endif %}
        <li><a href="{{ link }}"><i class="fa fa-book"></i> Read More</a></li>
      </ul>
    </div>
  </div>
</script>
<script src="/vendor/audiojs/audio.min.js"></script>
<script src="/vendor/jquery.js"></script>
<script src="/vendor/typeahead.js"></script>
<script src="/vendor/nunjucks.js"></script>
<script src="/vendor/masonry.pkgd.js"></script>
<script src="/vendor/bacon.js"></script>
<script src="/api/tags.js"></script>
<script src="/api/podcasts.js"></script>
<script>
var resultsTemplate = $('#results-holder').children().remove();
var postTemplate = $.trim($('#post-template').text());
var playlistTemplate = $.trim($('#playlist-template').text());

// https://gist.github.com/jharding/9458744#file-the-basics-js
var substringMatcher = function(strs) {
  return function findMatches(q, cb) {
    var matches, substrRegex;

    // an array that will be populated with substring matches
    matches = [];

    // regex used to determine if a string contains the substring `q`
    substrRegex = new RegExp(q, 'i');

    // iterate through the pool of strings and for any string that
    // contains the substring `q`, add it to the `matches` array
    $.each(strs, function(i, str) {
      if (substrRegex.test(str)) {
        // the typeahead jQuery plugin expects suggestions to a
        // JavaScript object, refer to typeahead docs for more info
        matches.push({ value: str });
      }
    });

    cb(matches);
  };
};

function setupSearch(queries) {
  var matcher = substringMatcher(Object.keys(TAGS));

  $('#search').typeahead({
    hint: true,
    highlight: true,
    minLength: 1
  }, {
    name: 'tags',
    displayKey: 'value',
    source: matcher
  }).on('keyup', function(event) {
    var val = $(this).val();
    if (event.which == 27)
      return $(this).typeahead('val', '').trigger('keyup');
    if (val == 'podcast') {
      queries.push('podcast');
    } else if (val in TAGS) {
      queries.push(TAGS[val]);
    } else {
      if (event.which == 13 && val) {
        matcher(val, function(matches) {
          if (matches.length) {
            val = matches[0].value;
            $(this).typeahead('val', val).trigger('keyup');
          }
        }.bind(this));
      } else {
        queries.push(null);
      }
    }
  });
}

function normalizePost(post) {
  if (post.author == 'lifeofthelaw')
    post.author = null;
  if (post.thumbnail && !post.thumbnail.width) post.thumbnail = null;
  if (post.thumbnail) {
    post.thumbnail.height = post.thumbnail.height * COLUMN_WIDTH /
                            post.thumbnail.width;
    post.thumbnail.width = COLUMN_WIDTH;
  }
  if (post.enclosure)
    post.enclosurePodcastInfo = JSON.stringify({
      id: post.id,
      title: post.title,
      pubdate: post.pubdate
    });
  post.pubdate = new Date(post.pubdate);
  return post;
}

function postRenderer() {
  var postsSoFar = 0;

  return function renderPost(post) {
    post = normalizePost(post);
    post.isWide = (++postsSoFar == 1);
    return $(nunjucks.renderString(postTemplate, post)).first();
  };
}

function setupPlayer() {
  var mp3player = audiojs.create($('#mp3player')[0]);
  var player = $('.player');
  var currentID = PODCASTS[0].id;

  player.find('.title').text(PODCASTS[0].title);
  mp3player.load('/api/audio/' + PODCASTS[0].id);

  $('body').on('click', '[role="play-podcast"]', function(e) {
    e.preventDefault();
    var info = JSON.parse($(this).attr('data-podcast-info'));
    var player = $('.player');

    $('.title', player).html(info.title);
    $('.subtitle', player).text(new Date(info.pubdate).toDateString());

    currentID = info.id;
    mp3player.load('/api/audio/' + info.id);
    mp3player.play();
  });

  player.on('click', '[role="show-playlist"]', function() {
    var playlist = $('.playlist', this);

    if (playlist.is(':visible')) {
      playlist.hide();
    } else {
      playlist.remove();
      playlist = $(nunjucks.renderString(playlistTemplate, {
        currentID: currentID,
        podcasts: PODCASTS.map(normalizePost)
      })).first();
      playlist.appendTo(this);
    }
  });

  player.on('click', '[role="show-all-episodes"]', function() {
    $('#search').typeahead('val', 'podcast').trigger('keyup');
  });
}

function scrollifyPosts(qs) {
  qs = qs || {};

  if ($('#results').length) {
    $('#results').masonry('destroy');
    $('#results-holder').empty();
  }

  resultsTemplate.clone().appendTo('#results-holder');

  var startPage = qs.page || 1;
  var results = $('#results');
  var more = $('#more');
  var spinner = $('#spinner');
  var renderPost = postRenderer();
  var fetchMore = more.asEventStream('click')
    .scan(startPage, function increment(page) { return page + 1; });
  var fetchedResults = fetchMore.flatMap(function(page) {
    var url = '/api/posts?' + $.param($.extend({}, qs, {page: page}));
    return Bacon.fromPromise($.getJSON(url));
  });
  var morePagesLeft = fetchedResults.map(function(info) {
    return info.page < info.pages;
  }).toProperty(false);
  var waiting = fetchMore.awaiting(fetchedResults);

  results.masonry({
    columnWidth: COLUMN_WIDTH,
    gutter: GUTTER_WIDTH,
    itemSelector: '.post'
  });

  fetchedResults.onValue(function(info) {
    info.posts.forEach(function(post) {
      results.masonry('appended', renderPost(post).appendTo(results)[0]);
      results.masonry();
    });
  });

  waiting.assign(spinner, 'toggle');
  waiting.not().and(morePagesLeft).assign(more, 'toggle');

  // TODO: Handle ajax errors somehow, e.g. via fetchedResults.onError().
}

$(function() {
  var queries = new Bacon.Bus();

  nunjucks.configure({autoescape: true});
  setupPlayer();
  setupSearch(queries);
  queries.debounce(300).skipDuplicates().onValue(function(q) {
    if (q === null) return scrollifyPosts();
    if (typeof(q) == 'number')
      scrollifyPosts({tag_id: q});
    else
      scrollifyPosts({category_name: q});
  });
  queries.push(null);
});
</script>
